<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cryptiki Password Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      color-scheme: light;
      --bg: #f6f7fb;
      --surface: #ffffff;
      --surface-muted: #f1f5f9;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 1px 2px rgba(15, 23, 42, 0.06),
        0 8px 24px rgba(15, 23, 42, 0.08);
      --radius: 14px;
      --radius-sm: 10px;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --focus: 0 0 0 4px rgba(37, 99, 235, 0.18);
      --max: 1100px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
        Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.45;
    }

    a {
      color: var(--primary);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    .container {
      width: min(var(--max), calc(100% - 2rem));
      margin-inline: auto;
    }

    [x-cloak] {
      display: none !important;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .app-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(246, 247, 251, 0.86);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(226, 232, 240, 0.9);
    }

    .header-inner {
      padding: 1rem 0;
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    .brand {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .brand h1 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.2px;
    }

    .tagline {
      margin-top: 0.15rem;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.6rem;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 999px;
      font-size: 0.85rem;
      color: var(--muted);
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

	    .badge-dot {
	      width: 0.55rem;
	      height: 0.55rem;
	      border-radius: 999px;
	      background: var(--badge-dot, #94a3b8);
	      box-shadow: 0 0 0 3px var(--badge-ring, rgba(148, 163, 184, 0.18));
	    }

    .panels {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    .panel,
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0.9rem;
    }

    .panel-title {
      margin: 0 0 0.6rem;
      font-size: 0.78rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.7rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      min-width: 0;
    }

    .field > span {
      font-size: 0.86rem;
      color: var(--muted);
    }

    .help {
      margin-top: 0.2rem;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 0;
    }

    input,
    textarea {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      color: var(--text);
      font-size: 0.95rem;
    }

    textarea {
      resize: vertical;
    }

    input:focus,
    textarea:focus,
    summary:focus {
      outline: none;
      border-color: rgba(37, 99, 235, 0.55);
      box-shadow: var(--focus);
    }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: var(--surface-muted);
      color: var(--text);
      border-radius: 12px;
      padding: 0.65rem 0.8rem;
      font-weight: 650;
      font-size: 0.95rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      white-space: nowrap;
      user-select: none;
    }

    .btn:hover {
      background: #e8eefc;
      border-color: #cbd5e1;
    }

	    .btn:active {
	      transform: translateY(1px);
	    }

	    .btn:disabled {
	      opacity: 0.55;
	      cursor: not-allowed;
	      transform: none;
	    }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }
    .btn-primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
    }

    .btn-ghost {
      background: transparent;
    }
    .btn-ghost:hover {
      background: rgba(2, 6, 23, 0.05);
      border-color: #cbd5e1;
    }

    .btn-mini {
      padding: 0.5rem 0.6rem;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
    }

    .btn-danger-ghost {
      background: transparent;
      border-color: rgba(220, 38, 38, 0.35);
      color: var(--danger);
    }
    .btn-danger-ghost:hover {
      background: rgba(220, 38, 38, 0.08);
      border-color: rgba(220, 38, 38, 0.55);
    }

    button[aria-busy="true"] {
      opacity: 0.78;
      pointer-events: none;
    }

    button[aria-busy="true"]::after {
      content: "";
      width: 1em;
      height: 1em;
      margin-left: 0.55rem;
      border-radius: 999px;
      border: 2px solid rgba(15, 23, 42, 0.25);
      border-top-color: rgba(15, 23, 42, 0.65);
      animation: spin 0.7s linear infinite;
    }

    .btn-primary[aria-busy="true"]::after {
      border-color: rgba(255, 255, 255, 0.55);
      border-top-color: #fff;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    details.tools > summary {
      list-style: none;
    }

	    details.tools > summary::-webkit-details-marker {
	      display: none;
	    }

	    details.tools {
	      position: relative;
	    }

	    .toolbar-row {
	      display: flex;
	      flex-wrap: wrap;
	      gap: 0.5rem;
	      align-items: center;
	    }

	    .menu {
	      position: absolute;
	      right: 0;
	      top: calc(100% + 0.5rem);
	      padding: 0.45rem;
	      border: 1px solid var(--border);
	      border-radius: var(--radius);
	      background: var(--surface);
	      box-shadow: var(--shadow);
	      display: flex;
	      flex-direction: column;
	      gap: 0.4rem;
	      min-width: 240px;
	    }

	    .menu .btn {
	      width: 100%;
	      justify-content: flex-start;
	    }

	    .menu-sep {
	      height: 1px;
	      background: var(--border);
	      margin: 0.15rem 0;
	    }

    main {
      padding: 1rem 0 2rem;
    }

    .content-header {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      margin-bottom: 0.75rem;
    }

    .content-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-end;
      align-items: center;
    }

    .entries {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    .entry-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0.9rem;
    }

    .entry-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .entry-top .site {
      flex: 1 1 auto;
      min-width: 0;
    }

    .entry-grid {
      margin-top: 0.75rem;
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    .note-toggle {
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .note-dot {
      display: inline-block;
      width: 0.55rem;
      height: 0.55rem;
      border-radius: 999px;
      background: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.14);
    }

    footer {
      padding: 1.5rem 0 2rem;
      text-align: center;
      color: var(--muted);
      font-size: 0.86rem;
    }

    @media (min-width: 900px) {
      .panels {
        grid-template-columns: 1.25fr 1fr;
        align-items: start;
      }

      .form-grid {
        grid-template-columns: 1fr 1fr;
      }

      .content-header {
        flex-direction: row;
        align-items: flex-end;
        justify-content: space-between;
      }

      .entry-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>

  <script>
    // --- Crypto helpers (Web Crypto API) ---

    // API base URL:
    // - When served from a web origin, default to same-origin ("").
    // - When opened locally (file://), default to https://cryptiki.com for easy testing.
    const API_BASE_URL = (() => {
      const explicit = (window.API_BASE_URL || "").trim();
      const inferred = window.location.protocol === "file:" ? "https://cryptiki.com" : "";
      const base = (explicit || inferred).trim();
      return base.replace(/\/+$/, "");
    })();
    const SALT_STRING = "Cryptiki 2.0";
    const PBKDF2_ITER = 133700;
    const KEY_LEN_BYTES = 32; // 256-bit
    const encoder = new TextEncoder();
    const decoder = new TextDecoder();

    function bytesToHex(bytes) {
      return Array.from(bytes)
        .map((b) => b.toString(16).padStart(2, "0"))
        .join("");
    }

    function hexToBytes(hex) {
      if (!hex) return new Uint8Array();
      const arr = new Uint8Array(hex.length / 2);
      for (let i = 0; i < hex.length; i += 2) {
        arr[i / 2] = parseInt(hex.substr(i, 2), 16);
      }
      return arr;
    }

    function bytesToBase64(bytes) {
      let binary = "";
      for (let i = 0; i < bytes.length; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }

    function base64ToBytes(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes;
    }

    async function pbkdf2(passwordBytes, saltBytes) {
      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        passwordBytes,
        { name: "PBKDF2" },
        false,
        ["deriveBits"]
      );
      const bits = await crypto.subtle.deriveBits(
        {
          name: "PBKDF2",
          hash: "SHA-256",
          iterations: PBKDF2_ITER,
          salt: saltBytes,
        },
        keyMaterial,
        KEY_LEN_BYTES * 8
      );
      return new Uint8Array(bits);
    }

    async function sha256Hex(str) {
      const hash = await crypto.subtle.digest("SHA-256", encoder.encode(str));
      return bytesToHex(new Uint8Array(hash)).toLowerCase();
    }

    async function aesCtrEncrypt(plaintext, keyBytes) {
      const iv = crypto.getRandomValues(new Uint8Array(16));
      const key = await crypto.subtle.importKey(
        "raw",
        keyBytes,
        { name: "AES-CTR", length: 256 },
        false,
        ["encrypt"]
      );
      const ciphertext = await crypto.subtle.encrypt(
        { name: "AES-CTR", counter: iv, length: 128 },
        key,
        encoder.encode(plaintext)
      );
      return { iv, ciphertext: new Uint8Array(ciphertext) };
    }

    async function aesCtrDecrypt(ciphertextBytes, keyBytes, ivBytes) {
      const key = await crypto.subtle.importKey(
        "raw",
        keyBytes,
        { name: "AES-CTR", length: 256 },
        false,
        ["decrypt"]
      );
      const plaintext = await crypto.subtle.decrypt(
        { name: "AES-CTR", counter: ivBytes, length: 128 },
        key,
        ciphertextBytes
      );
      return decoder.decode(plaintext);
    }

    // --- Alpine app ---

    function cryptikiApp() {
      return {
        // state
        apiBaseUrl: API_BASE_URL,
        page: "",
        password: "",
        showPass: false,
        filter: "",
        entries: [],
        importText: "",
        showImport: false,
        busy: false,
        loaded: false,
        dirty: false,
        lastSyncedPage: null,

        keyhashHex: null,
        passkeyHex: null,
        keyhashBytes: null,
        passkeyBytes: null,
        credentialsStored: false,

        init() {
          if (!("crypto" in window) || !crypto.subtle) {
            alert("This browser does not support the Web Crypto API.");
            return;
          }

          try {
            const kh = localStorage.getItem("keyhash");
            const pk = localStorage.getItem("passkey");
            if (kh && pk) {
              this.keyhashHex = kh;
              this.passkeyHex = pk;
              this.keyhashBytes = hexToBytes(kh);
              this.passkeyBytes = hexToBytes(pk);
              this.page = localStorage.getItem("page") || "";
              this.password = localStorage.getItem("password") || "";
              this.credentialsStored = true;
            }
          } catch (e) {
            console.error("Failed to load stored credentials", e);
          }
        },

        sessionReady() {
          return !!(this.page && this.password);
        },

        markDirty() {
          this.dirty = true;
        },

        statusLabel() {
          if (!this.sessionReady()) return "Enter page & password";
          if (this.busy) return "Working…";
          if (this.dirty) return "Unsaved changes";
          if (this.loaded) return "Saved";
          return "Not loaded";
        },

        statusBadgeStyle() {
          if (!this.sessionReady()) {
            return "--badge-dot:#94a3b8; --badge-ring: rgba(148, 163, 184, 0.18)";
          }
          if (this.busy) {
            return "--badge-dot:#0ea5e9; --badge-ring: rgba(14, 165, 233, 0.14)";
          }
          if (this.dirty) {
            return "--badge-dot:#f59e0b; --badge-ring: rgba(245, 158, 11, 0.14)";
          }
          if (this.loaded) {
            return "--badge-dot:#16a34a; --badge-ring: rgba(22, 163, 74, 0.12)";
          }
          return "--badge-dot:#94a3b8; --badge-ring: rgba(148, 163, 184, 0.18)";
        },

        caselessMatch(needle, ...haystack) {
          if (!needle) return true;
          const n = String(needle).toUpperCase();
          return haystack.some((h) =>
            (h || "").toString().toUpperCase().includes(n)
          );
        },

        async calculateKeys(inputPage, inputPassword) {
          const pageBytes = encoder.encode(inputPage);
          const saltBytes = encoder.encode(SALT_STRING);
          const keyhashBytes = await pbkdf2(pageBytes, saltBytes);
          const keyhashHex = bytesToHex(keyhashBytes);

          const passkeyBytes = await pbkdf2(
            encoder.encode(inputPassword),
            keyhashBytes
          );
          const passkeyHex = bytesToHex(passkeyBytes);

          return { keyhashBytes, keyhashHex, passkeyBytes, passkeyHex };
        },

        async storeCredentials() {
          if (!this.page || !this.password) {
            alert("Page and password must be set");
            return;
          }
          try {
            const {
              keyhashBytes,
              keyhashHex,
              passkeyBytes,
              passkeyHex,
            } = await this.calculateKeys(this.page, this.password);

            localStorage.setItem("keyhash", keyhashHex);
            localStorage.setItem("passkey", passkeyHex);
            localStorage.setItem("page", this.page);
            localStorage.setItem("password", this.password);

            this.keyhashBytes = keyhashBytes;
            this.keyhashHex = keyhashHex;
            this.passkeyBytes = passkeyBytes;
            this.passkeyHex = passkeyHex;
            this.credentialsStored = true;

            alert("Credentials stored successfully");
          } catch (e) {
            console.error(e);
            alert("Failed to derive keys");
          }
        },

        clearStoredCredentials() {
          localStorage.removeItem("keyhash");
          localStorage.removeItem("passkey");
          localStorage.removeItem("page");
          localStorage.removeItem("password");
          this.keyhashHex = null;
          this.passkeyHex = null;
          this.keyhashBytes = null;
          this.passkeyBytes = null;
          this.credentialsStored = false;
          alert("Stored credentials have been cleared");
        },

        clearAllEntries() {
          if (!this.entries.length) return;
          if (
            !confirm(
              "Clear all entries from the current view?\n\nThis only changes your local state until you save."
            )
          ) {
            return;
          }
          this.entries = [];
          this.filter = "";
          this.markDirty();
        },

        addEntry() {
          const service = prompt("Site");
          if (service === null) return;
          const username = prompt("Username");
          if (username === null) return;
          const password = prompt("Password");
          if (password === null) return;

          this.entries.push({
            service,
            username,
            password,
            text: "",
          });
          this.filter = service;
          this.markDirty();
        },

        sortEntries() {
          this.entries.sort((a, b) =>
            (a.service || "").localeCompare(b.service || "")
          );
          this.markDirty();
        },

        deleteEntry(index) {
          this.entries.splice(index, 1);
          this.markDirty();
        },

        importEntries() {
          const entryRe = /^(\w.*):\s+(.+) \/ (.+)$/;
          const lines = (this.importText || "").split("\n");
          this.entries = [];

          for (const rawLine of lines) {
            const line = rawLine;
            if (!line.trim() && !this.entries.length) continue;

            const match = line.match(entryRe);
            if (match) {
              this.entries.push({
                service: match[1],
                username: match[2],
                password: match[3],
                text: "",
              });
            } else if (line.startsWith("!")) {
              this.entries.push({
                service: line.slice(1),
                username: "",
                password: "",
                text: "",
              });
            } else if (this.entries.length) {
              const prev = this.entries[this.entries.length - 1];
              if (prev.text.length > 0) prev.text += "\n";
              prev.text += line.trim();
            }
          }

          this.sortEntries();
          this.showImport = false;
          this.importText = "";
          this.markDirty();
        },

        async copy(text) {
          if (!text) return;
          try {
            await navigator.clipboard.writeText(text);
          } catch (e) {
            console.error("Clipboard copy failed", e);
          }
        },

        async savePage() {
          if (!this.page || !this.password) {
            alert("Page and password must be set");
            return;
          }

          if (!this.dirty) {
            return;
          }

          if (this.lastSyncedPage && this.lastSyncedPage !== this.page) {
            const ok = confirm(
              `You're about to save to a different page than you last synced.\n\nLast: ${this.lastSyncedPage}\nNow:  ${this.page}\n\nContinue?`
            );
            if (!ok) return;
          }

          this.busy = true;
          await new Promise((r) => setTimeout(r, 10)); // mimic old busy behavior

          let keyhashBytes, keyhashHex, passkeyBytes, passkeyHex;
          try {
            if (
              this.credentialsStored &&
              localStorage.getItem("page") === this.page &&
              this.keyhashBytes &&
              this.passkeyBytes
            ) {
              keyhashBytes = this.keyhashBytes;
              keyhashHex = this.keyhashHex;
              passkeyBytes = this.passkeyBytes;
              passkeyHex = this.passkeyHex;
            } else {
              ({
                keyhashBytes,
                keyhashHex,
                passkeyBytes,
                passkeyHex,
              } = await this.calculateKeys(this.page, this.password));
            }

            const payload = JSON.stringify(this.entries);
            const contenthash = await sha256Hex(payload);
            const { iv, ciphertext } = await aesCtrEncrypt(
              payload,
              passkeyBytes
            );

            const content = {
              iv: bytesToHex(iv),
              deriv: "PBKDF2",
              iter: PBKDF2_ITER,
              hash: "SHA256",
              salt: SALT_STRING,
              crypto: "AES256CTR",
              encrypted: bytesToBase64(ciphertext),
            };

            const body = new URLSearchParams({
              keyhash: keyhashHex,
              passhash: passkeyHex,
              contenthash,
              content: JSON.stringify(content),
            }).toString();

            const res = await fetch(this.apiBaseUrl + "/put.php", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body,
            });

            if (!res.ok) {
              const text = await res.text().catch(() => "");
              console.error("AJAX error:", res.status, text);
              alert(
                `Error saving page: ${res.status} ${res.statusText}\n${text}`
              );
            } else {
              console.log("Page saved");
              this.loaded = true;
              this.dirty = false;
              this.lastSyncedPage = this.page;
              alert("Page saved successfully");
            }
          } catch (e) {
            console.error("Save failed", e);
            alert("Error saving page");
          } finally {
            this.busy = false;
          }
        },

        async loadPage() {
          if (!this.page || !this.password) {
            alert("Page and password must be set");
            return;
          }

          if (this.dirty) {
            const ok = confirm(
              "You have unsaved changes.\n\nReloading will discard your local changes.\n\nContinue?"
            );
            if (!ok) return;
          }

          this.busy = true;
          await new Promise((r) => setTimeout(r, 10));

          let keyhashBytes, keyhashHex, passkeyBytes;
          try {
            if (
              this.credentialsStored &&
              localStorage.getItem("page") === this.page &&
              this.keyhashBytes &&
              this.passkeyBytes
            ) {
              keyhashBytes = this.keyhashBytes;
              keyhashHex = this.keyhashHex;
              passkeyBytes = this.passkeyBytes;
            } else {
              ({
                keyhashBytes,
                keyhashHex,
                passkeyBytes,
              } = await this.calculateKeys(this.page, this.password));
            }

            const res = await fetch(
              this.apiBaseUrl + "/get.php?keyhash=" + keyhashHex
            );
            if (!res.ok) {
              console.error("HTTP error " + res.status);
              this.busy = false;
              return;
            }

            let { contenthash, content } = await res.json();

            if (!contenthash || !content) {
              alert("No such page");
              console.error({ contenthash, content });
              this.busy = false;
              return;
            }

            if (typeof content === "string") {
              content = JSON.parse(content);
            }

            const ivBytes = hexToBytes(content.iv);
            const ciphertextBytes = base64ToBytes(content.encrypted);

            try {
              const plaintext = await aesCtrDecrypt(
                ciphertextBytes,
                passkeyBytes,
                ivBytes
              );
              const plainhash = await sha256Hex(plaintext);

              if (contenthash.toLowerCase() !== plainhash.toLowerCase()) {
                throw new Error(
                  `Content hash mismatch: ${contenthash} != ${plainhash}`
                );
              }

              this.entries = JSON.parse(plaintext);
              this.filter = "";
              this.loaded = true;
              this.dirty = false;
              this.lastSyncedPage = this.page;
            } catch (e) {
              console.error(e);
              alert(
                "Decryption failed. Please check your page and password."
              );
            }
          } catch (e) {
            console.error("Load failed", e);
          } finally {
            this.busy = false;
          }
        },
      };
    }
  </script>

  <!-- Alpine.js (from CDN) -->
  <script
    src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    defer
  ></script>
</head>

<body x-data="cryptikiApp()" x-init="init()">
  <header class="app-header">
    <div class="container header-inner">
      <div class="brand">
        <div>
          <h1>Cryptiki</h1>
          <div class="tagline">Client-side encrypted password store</div>
        </div>
        <div
          class="badge"
          style="--badge-dot:#16a34a; --badge-ring: rgba(22, 163, 74, 0.12)"
          title="API endpoint used by this page"
        >
          <span class="badge-dot" aria-hidden="true"></span>
          <span x-text="apiBaseUrl ? apiBaseUrl : 'Same origin'"></span>
        </div>
      </div>

      <div class="panels">
        <section class="panel" aria-label="Session and sync">
          <h2 class="panel-title">Store</h2>
          <div class="form-grid">
            <label class="field">
              <span>Page</span>
              <input
                id="page"
                type="text"
                inputmode="text"
                autocomplete="off"
                placeholder="e.g. personal"
                x-model.trim="page"
              />
              <div class="help">Logical “file” name</div>
            </label>

            <label class="field">
              <span>Password</span>
              <div class="input-row">
                <input
                  id="password"
                  :type="showPass ? 'text' : 'password'"
                  x-model="password"
                  autocomplete="off"
                  placeholder="Your master password"
                />
                <button
                  type="button"
                  class="btn btn-ghost btn-mini"
                  @click="showPass = !showPass"
                  :aria-pressed="showPass"
                  x-text="showPass ? 'Hide' : 'Show'"
                ></button>
              </div>
              <div class="help">Used to derive encryption keys</div>
            </label>
          </div>

          <div
            class="toolbar-row"
            style="margin-top: 0.75rem; align-items: flex-end; justify-content: space-between"
          >
            <div class="toolbar-row" style="flex: 1 1 auto; justify-content: flex-start">
              <span
                class="badge"
                :style="statusBadgeStyle()"
                title="Store status"
              >
                <span class="badge-dot" aria-hidden="true"></span>
                <span x-text="statusLabel()"></span>
              </span>
              <span
                class="badge"
                x-show="credentialsStored"
                x-cloak
                style="--badge-dot:#0ea5e9; --badge-ring: rgba(14, 165, 233, 0.14)"
                title="Stored in this browser only"
              >
                <span class="badge-dot" aria-hidden="true"></span>
                Cached credentials
              </span>
            </div>

            <div class="toolbar-row" style="justify-content: flex-end">
              <button
                type="button"
                class="btn btn-ghost"
                :disabled="!sessionReady() || busy"
                :aria-busy="busy"
                @click="loadPage()"
                x-text="loaded ? 'Reload' : 'Load'"
              ></button>

              <button
                type="button"
                :class="dirty ? 'btn btn-primary' : 'btn btn-ghost'"
                :disabled="!sessionReady() || busy || !dirty"
                :aria-busy="busy"
                @click="savePage()"
                x-text="dirty ? (loaded ? 'Save changes' : 'Save new store') : (loaded ? 'Saved' : 'Save')"
                :title="dirty ? 'Encrypt and save to server' : 'No changes to save'"
              ></button>

              <details class="tools" role="list">
                <summary class="btn btn-ghost" role="button">Tools ▾</summary>
                <div class="menu">
                  <button
                    type="button"
                    class="btn btn-ghost"
                    @click="showImport = true; $event.currentTarget.closest('details')?.removeAttribute('open')"
                  >
                    Import old format
                  </button>
                  <button
                    type="button"
                    class="btn btn-ghost"
                    @click="storeCredentials(); $event.currentTarget.closest('details')?.removeAttribute('open')"
                  >
                    Cache credentials
                  </button>
                  <div class="menu-sep"></div>
                  <button
                    type="button"
                    class="btn btn-danger-ghost"
                    @click="clearStoredCredentials(); $event.currentTarget.closest('details')?.removeAttribute('open')"
                    x-show="credentialsStored"
                    x-cloak
                  >
                    Clear cached credentials
                  </button>
                  <button
                    type="button"
                    class="btn btn-danger-ghost"
                    @click="clearAllEntries(); $event.currentTarget.closest('details')?.removeAttribute('open')"
                    x-show="entries.length > 0"
                    x-cloak
                  >
                    Clear all entries
                  </button>
                </div>
              </details>
            </div>
          </div>

          <div class="help">Encrypted locally; server never sees plaintext.</div>
        </section>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="content-header" aria-label="Entries toolbar">
        <label class="field" style="flex: 1 1 auto">
          <span class="sr-only">Filter</span>
          <input
            id="filter"
            type="search"
            placeholder="Filter (use * to show all)"
            x-model="filter"
          />
        </label>

        <div class="content-actions">
          <button type="button" class="btn btn-ghost" @click="sortEntries()">
            Sort A–Z
          </button>
          <button type="button" class="btn btn-primary" @click="addEntry()">
            New entry
          </button>
        </div>
      </section>

      <!-- Import view -->
      <section class="card" x-show="showImport" x-cloak>
        <h2 style="margin: 0 0 0.5rem; font-size: 1.05rem">Import</h2>
        <div class="help" style="margin-bottom: 0.6rem">
          Paste old Cryptiki entries (one per line) and import them into the current page.
        </div>
        <textarea
          x-model="importText"
          rows="8"
          placeholder="example.com: user / password"
        ></textarea>
        <div class="toolbar-row" style="margin-top: 0.6rem; justify-content: flex-end">
          <button type="button" class="btn btn-primary" @click="importEntries()">Import</button>
          <button
            type="button"
            class="btn btn-ghost"
            @click="showImport = false; importText = ''"
          >
            Cancel
          </button>
        </div>
      </section>

      <!-- Empty state -->
      <section class="card" x-show="!showImport && entries.length === 0" x-cloak>
        <h2 style="margin: 0 0 0.35rem; font-size: 1.15rem">No entries yet</h2>
        <div class="help">Create one with “New entry”, then Save to sync it.</div>
      </section>

      <!-- Security notice when there are entries but filter is empty -->
      <section class="card" x-show="!showImport && entries.length > 0 && !filter" x-cloak>
        <h2 style="margin: 0 0 0.35rem; font-size: 1.05rem">Passwords hidden</h2>
        <div class="help" style="margin-bottom: 0.6rem">
          For shoulder-surfing safety, passwords stay masked until you filter or show all.
        </div>
        <div class="toolbar-row">
          <button type="button" class="btn btn-primary" @click="filter = '*'">Show all</button>
        </div>
      </section>

      <!-- Entries list -->
      <section class="entries" x-show="!showImport && entries.length > 0 && filter" x-cloak>
        <template x-for="(entry, index) in entries" :key="index">
          <article
            class="entry-card"
            x-data="{ showPassword: false, noteOpen: false }"
            x-show="filter === '*' || caselessMatch(filter, entry.service, entry.username, entry.text)"
          >
            <div class="entry-top">
              <div class="site">
                <input
                  type="text"
                  x-model="entry.service"
                  @input="markDirty()"
                  placeholder="Site"
                />
              </div>
              <button
                type="button"
                class="btn btn-danger-ghost btn-mini"
                title="Delete entry"
                @click="$root.deleteEntry(index)"
              >
                Delete
              </button>
            </div>

            <div class="entry-grid">
              <label class="field">
                <span>Username</span>
                <div class="input-row">
                  <input
                    type="text"
                    x-model="entry.username"
                    @input="markDirty()"
                    placeholder="Username"
                  />
                  <button
                    type="button"
                    class="btn btn-ghost btn-mini"
                    @click="$root.copy(entry.username)"
                    title="Copy username"
                  >
                    Copy
                  </button>
                </div>
              </label>

              <label class="field">
                <span>Password</span>
                <div class="input-row">
                  <input
                    :type="showPassword ? 'text' : 'password'"
                    x-model="entry.password"
                    @input="markDirty()"
                    placeholder="Password"
                  />
                  <button
                    type="button"
                    class="btn btn-ghost btn-mini"
                    @click="$root.copy(entry.password)"
                    title="Copy password"
                  >
                    Copy
                  </button>
                  <button
                    type="button"
                    class="btn btn-ghost btn-mini"
                    @click="showPassword = !showPassword"
                    :aria-pressed="showPassword"
                    x-text="showPassword ? 'Hide' : 'Show'"
                    :title="showPassword ? 'Hide password' : 'Show password'"
                  ></button>
                </div>
              </label>
            </div>

            <div class="note-toggle">
              <button type="button" class="btn btn-ghost btn-mini" @click="noteOpen = !noteOpen">
                <span x-text="noteOpen ? 'Hide note' : 'Note'"></span>
                <span
                  x-show="entry.text && entry.text.length"
                  class="note-dot"
                  aria-hidden="true"
                ></span>
              </button>
            </div>

            <div x-show="noteOpen" x-cloak style="margin-top: 0.5rem">
              <textarea
                x-model="entry.text"
                @input="markDirty()"
                rows="2"
                placeholder="Secure note…"
              ></textarea>
            </div>
          </article>
        </template>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">
      &copy; Joonas Pihlajamaa. All rights reserved.
    </div>
  </footer>
</body>
</html>
