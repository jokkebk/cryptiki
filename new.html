<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cryptiki Password Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      color-scheme: light;
      --bg: #f6f7fb;
      --surface: #fff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(15,23,42,.08);
      --radius: 14px;
      --radius-sm: 10px;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --focus: 0 0 0 4px rgba(37,99,235,.18);
      --max: 1100px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font: 1rem/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .container { width: min(var(--max), calc(100% - 2rem)); margin-inline: auto; }
    [x-cloak] { display: none !important; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    /* Utilities */
    .flex { display: flex; align-items: center; }
    .flex-wrap { flex-wrap: wrap; }
    .gap-sm { gap: .5rem; }
    .gap-md { gap: .65rem; }
    .justify-end { justify-content: flex-end; }
    .justify-between { justify-content: space-between; }
    .flex-1 { flex: 1 1 auto; }
    .mt-sm { margin-top: .5rem; }
    .mt-md { margin-top: .75rem; }

    /* Header */
    .app-header { background: var(--bg); border-bottom: 1px solid rgba(226,232,240,.85); }
    .header-inner { padding: .85rem 0; display: grid; gap: .75rem; }
    .brand { display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
    .brand h1 { margin: 0; font-size: 1.1rem; letter-spacing: .2px; }
    .tagline { margin-top: .15rem; font-size: .9rem; color: var(--muted); }

    /* Badge */
    .badge {
      display: inline-flex; align-items: center; gap: .4rem;
      padding: .3rem .6rem; border: 1px solid var(--border);
      background: var(--surface); border-radius: 999px;
      font-size: .85rem; color: var(--muted); white-space: nowrap;
    }
    .badge-dot {
      width: .55rem; height: .55rem; border-radius: 999px;
      background: var(--dot, #94a3b8);
      box-shadow: 0 0 0 3px var(--ring, rgba(148,163,184,.18));
    }

    /* Panels & Cards */
    .panel, .card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: .75rem;
    }
    .panel-title { margin: 0 0 .6rem; font-size: .78rem; color: var(--muted); text-transform: uppercase; letter-spacing: .1em; }
    .help { margin-top: .2rem; font-size: .82rem; color: var(--muted); }

    /* Forms */
    .form-grid { display: grid; gap: .7rem; }
    .field { display: flex; flex-direction: column; gap: .35rem; min-width: 0; }
    .field > span { font-size: .86rem; color: var(--muted); }
    .input-row { display: flex; align-items: center; gap: .5rem; min-width: 0; }

    input, textarea {
      width: 100%; padding: .55rem .65rem;
      border: 1px solid var(--border); border-radius: 12px;
      background: #fff; color: var(--text); font-size: .95rem;
    }
    textarea { resize: vertical; }
    input:focus, textarea:focus, summary:focus {
      outline: none; border-color: rgba(37,99,235,.55); box-shadow: var(--focus);
    }

    /* Buttons */
    .btn {
      appearance: none; border: 1px solid var(--border);
      background: #f1f5f9; color: var(--text); border-radius: 12px;
      padding: .55rem .7rem; font-weight: 650; font-size: .95rem;
      cursor: pointer; display: inline-flex; align-items: center;
      justify-content: center; gap: .5rem; white-space: nowrap; user-select: none;
    }
    .btn:hover { background: #e8eefc; border-color: #cbd5e1; }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: .55; cursor: not-allowed; transform: none; }

    .btn-primary { background: var(--primary); border-color: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); }

    .btn-ghost { background: transparent; }
    .btn-ghost:hover { background: rgba(2,6,23,.05); border-color: #cbd5e1; }

    .btn-danger { background: transparent; border-color: rgba(220,38,38,.35); color: var(--danger); }
    .btn-danger:hover { background: rgba(220,38,38,.08); border-color: rgba(220,38,38,.55); }

    .btn-mini { padding: .4rem .55rem; border-radius: var(--radius-sm); font-size: .9rem; }
    .btn-icon { padding: .4rem; width: 2.25rem; gap: 0; line-height: 1; }

    .btn-note { position: relative; }
    .btn-note .note-dot { position: absolute; top: .4rem; right: .4rem; width: .45rem; height: .45rem; }

    .icon { width: 1.05rem; height: 1.05rem; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    button[aria-busy="true"] { opacity: .78; pointer-events: none; }
    button[aria-busy="true"]::after {
      content: ""; width: 1em; height: 1em; margin-left: .55rem;
      border-radius: 999px; border: 2px solid rgba(15,23,42,.25);
      border-top-color: rgba(15,23,42,.65); animation: spin .7s linear infinite;
    }
    .btn-primary[aria-busy="true"]::after { border-color: rgba(255,255,255,.55); border-top-color: #fff; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Menu */
    details.tools > summary { list-style: none; }
    details.tools > summary::-webkit-details-marker { display: none; }
    details.tools { position: relative; }
    .menu {
      position: absolute; right: 0; top: calc(100% + .5rem);
      padding: .45rem; border: 1px solid var(--border); border-radius: var(--radius);
      background: var(--surface); box-shadow: var(--shadow);
      display: flex; flex-direction: column; gap: .4rem; min-width: 240px;
    }
    .menu .btn { width: 100%; justify-content: flex-start; }
    .menu-sep { height: 1px; background: var(--border); margin: .15rem 0; }

    /* Main */
    main { padding: .85rem 0 2rem; }
    .content-header { display: flex; flex-direction: column; gap: .65rem; margin-bottom: .75rem; }
    .content-actions { display: flex; flex-wrap: wrap; gap: .5rem; justify-content: flex-end; align-items: center; }

    /* Entries */
    .entries { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .entry-card { border: 0; border-bottom: 1px solid var(--border); border-radius: 0; box-shadow: none; padding: .65rem; background: transparent; }
    .entries > .entry-card:last-child { border-bottom: 0; }
    .entry-top { display: grid; gap: .55rem; }
    .entry-top .site { min-width: 0; }

    .note-dot { display: inline-block; width: .55rem; height: .55rem; border-radius: 999px; background: #f59e0b; }

    footer { padding: 1.5rem 0 2rem; text-align: center; color: var(--muted); font-size: .86rem; }

    @media (min-width: 900px) {
      .form-grid { grid-template-columns: 1fr 1fr; }
      .content-header { flex-direction: row; align-items: flex-end; justify-content: space-between; }
      .entry-top { grid-template-columns: 1.3fr 1fr 1.2fr auto; align-items: center; column-gap: .6rem; }
    }
  </style>

  <script>
    const API_BASE_URL = (window.API_BASE_URL?.trim() || (location.protocol === "file:" ? "https://cryptiki.com" : "")).replace(/\/+$/, "");
    const SALT = "Cryptiki 2.0", ITER = 133700, enc = new TextEncoder(), dec = new TextDecoder();

    const hex = b => [...b].map(x => x.toString(16).padStart(2, "0")).join("");
    const unhex = h => h ? new Uint8Array(h.match(/.{2}/g).map(x => parseInt(x, 16))) : new Uint8Array();
    const b64 = b => btoa(String.fromCharCode(...b));
    const unb64 = s => Uint8Array.from(atob(s), c => c.charCodeAt(0));

    async function pbkdf2(pwd, salt) {
      const key = await crypto.subtle.importKey("raw", pwd, "PBKDF2", false, ["deriveBits"]);
      return new Uint8Array(await crypto.subtle.deriveBits({ name: "PBKDF2", hash: "SHA-256", iterations: ITER, salt }, key, 256));
    }

    async function sha256(s) {
      return hex(new Uint8Array(await crypto.subtle.digest("SHA-256", enc.encode(s)))).toLowerCase();
    }

    async function aesEncrypt(text, key) {
      const iv = crypto.getRandomValues(new Uint8Array(16));
      const k = await crypto.subtle.importKey("raw", key, { name: "AES-CTR", length: 256 }, false, ["encrypt"]);
      const ct = await crypto.subtle.encrypt({ name: "AES-CTR", counter: iv, length: 128 }, k, enc.encode(text));
      return { iv, ct: new Uint8Array(ct) };
    }

    async function aesDecrypt(ct, key, iv) {
      const k = await crypto.subtle.importKey("raw", key, { name: "AES-CTR", length: 256 }, false, ["decrypt"]);
      return dec.decode(await crypto.subtle.decrypt({ name: "AES-CTR", counter: iv, length: 128 }, k, ct));
    }

    function cryptikiApp() {
      return {
        apiBaseUrl: API_BASE_URL,
        page: "", password: "", showPass: false, filter: "",
        entries: [], importText: "", showImport: false,
        busy: false, loaded: false, dirty: false, lastSyncedPage: null,
        keys: null, credentialsStored: false,

        init() {
          if (!crypto?.subtle) return alert("Web Crypto API not supported.");
          try {
            const stored = ["keyhash", "passkey", "page", "password"].map(k => localStorage.getItem(k));
            if (stored[0] && stored[1]) {
              this.keys = { kh: stored[0], pk: stored[1], khB: unhex(stored[0]), pkB: unhex(stored[1]) };
              this.page = stored[2] || "";
              this.password = stored[3] || "";
              this.credentialsStored = true;
            }
          } catch (e) { console.error("Failed to load credentials", e); }
        },

        sessionReady() { return !!(this.page && this.password); },
        markDirty() { this.dirty = true; },

        statusLabel() {
          if (!this.sessionReady()) return "Enter page & password";
          if (this.busy) return "Working...";
          if (this.dirty) return "Unsaved changes";
          return this.loaded ? "Saved" : "Not loaded";
        },

        statusStyle() {
          const styles = {
            default: "--dot:#94a3b8;--ring:rgba(148,163,184,.18)",
            busy: "--dot:#0ea5e9;--ring:rgba(14,165,233,.14)",
            dirty: "--dot:#f59e0b;--ring:rgba(245,158,11,.14)",
            saved: "--dot:#16a34a;--ring:rgba(22,163,74,.12)"
          };
          if (!this.sessionReady()) return styles.default;
          if (this.busy) return styles.busy;
          if (this.dirty) return styles.dirty;
          return this.loaded ? styles.saved : styles.default;
        },

        getFilteredEntries() {
          if (!this.filter) return [];
          if (this.filter === "*") return this.entries;
          const needle = this.filter.toUpperCase();
          const score = e => {
            const s = (e.service || "").toUpperCase();
            if (s === needle) return 0;
            if (s.startsWith(needle)) return 1;
            if (s.includes(needle)) return 2;
            if ((e.username || "").toUpperCase().includes(needle)) return 3;
            if ((e.password || "").toUpperCase().includes(needle)) return 4;
            if ((e.text || "").toUpperCase().includes(needle)) return 5;
            return 6;
          };
          return this.entries.filter(e => score(e) < 6).sort((a, b) => score(a) - score(b));
        },

        async deriveKeys(page, pwd) {
          const khB = await pbkdf2(enc.encode(page), enc.encode(SALT));
          const pkB = await pbkdf2(enc.encode(pwd), khB);
          return { kh: hex(khB), pk: hex(pkB), khB, pkB };
        },

        async getKeys() {
          if (this.credentialsStored && localStorage.getItem("page") === this.page && this.keys) return this.keys;
          return await this.deriveKeys(this.page, this.password);
        },

        async storeCredentials() {
          if (!this.page || !this.password) return alert("Page and password required");
          try {
            const keys = await this.deriveKeys(this.page, this.password);
            localStorage.setItem("keyhash", keys.kh);
            localStorage.setItem("passkey", keys.pk);
            localStorage.setItem("page", this.page);
            localStorage.setItem("password", this.password);
            this.keys = keys;
            this.credentialsStored = true;
            alert("Credentials stored");
          } catch (e) { console.error(e); alert("Failed to derive keys"); }
        },

        clearCredentials() {
          ["keyhash", "passkey", "page", "password"].forEach(k => localStorage.removeItem(k));
          this.keys = null;
          this.credentialsStored = false;
          alert("Credentials cleared");
        },

        clearEntries() {
          if (!this.entries.length) return;
          if (!confirm("Clear all entries? (Local only until saved)")) return;
          this.entries = [];
          this.filter = "";
          this.markDirty();
        },

        addEntry() {
          const service = prompt("Site");
          if (service === null) return;
          const username = prompt("Username");
          if (username === null) return;
          const password = prompt("Password");
          if (password === null) return;
          this.entries.push({ service, username, password, text: "" });
          this.filter = service;
          this.markDirty();
        },

        sortEntries() {
          this.entries.sort((a, b) => (a.service || "").localeCompare(b.service || ""));
          this.markDirty();
        },

        deleteEntry(entry) {
          const i = this.entries.indexOf(entry);
          if (i > -1) { this.entries.splice(i, 1); this.markDirty(); }
        },

        importEntries() {
          const re = /^(\w.*):\s+(.+) \/ (.+)$/;
          this.entries = [];
          for (const line of this.importText.split("\n")) {
            if (!line.trim() && !this.entries.length) continue;
            const m = line.match(re);
            if (m) this.entries.push({ service: m[1], username: m[2], password: m[3], text: "" });
            else if (line.startsWith("!")) this.entries.push({ service: line.slice(1), username: "", password: "", text: "" });
            else if (this.entries.length) {
              const prev = this.entries.at(-1);
              prev.text += (prev.text ? "\n" : "") + line.trim();
            }
          }
          this.sortEntries();
          this.showImport = false;
          this.importText = "";
        },

        async copy(text) {
          if (!text) return;
          try { await navigator.clipboard.writeText(text); }
          catch { alert("Copy failed"); }
        },

        closeMenu(e) { e.currentTarget.closest("details")?.removeAttribute("open"); },

        async exportEntries() {
          if (!this.entries.length) return alert("No entries to export");
          const exportPwd = prompt("Export password (can be empty):");
          if (exportPwd === null) return;

          try {
            const payload = JSON.stringify(this.entries);
            const salt = "Cryptiki Export 1.0";
            const khB = await pbkdf2(enc.encode(salt), enc.encode(salt));
            const pkB = await pbkdf2(enc.encode(exportPwd), khB);
            const { iv, ct } = await aesEncrypt(payload, pkB);

            const exportData = JSON.stringify({
              iv: hex(iv), salt, iter: ITER, encrypted: b64(ct)
            });

            const html = this.generateExportHtml(exportData);
            const blob = new Blob([html], { type: "text/html" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `cryptiki-export-${new Date().toISOString().slice(0, 10)}.html`;
            a.click();
            URL.revokeObjectURL(url);
          } catch (e) { console.error(e); alert("Export failed"); }
        },

        generateExportHtml(exportData) {
          const scriptContent = `
    const DATA = ${exportData};
    const ITER = ${ITER};
    const enc = new TextEncoder(), dec = new TextDecoder();
    const hex = b => [...b].map(x => x.toString(16).padStart(2, "0")).join("");
    const unhex = h => h ? new Uint8Array(h.match(/.{2}/g).map(x => parseInt(x, 16))) : new Uint8Array();
    const unb64 = s => Uint8Array.from(atob(s), c => c.charCodeAt(0));

    async function pbkdf2(pwd, salt) {
      const key = await crypto.subtle.importKey("raw", pwd, "PBKDF2", false, ["deriveBits"]);
      return new Uint8Array(await crypto.subtle.deriveBits({ name: "PBKDF2", hash: "SHA-256", iterations: ITER, salt }, key, 256));
    }

    async function aesDecrypt(ct, key, iv) {
      const k = await crypto.subtle.importKey("raw", key, { name: "AES-CTR", length: 256 }, false, ["decrypt"]);
      return dec.decode(await crypto.subtle.decrypt({ name: "AES-CTR", counter: iv, length: 128 }, k, ct));
    }

    async function decrypt() {
      const pwd = document.getElementById("pwd").value;
      const err = document.getElementById("error");
      err.classList.add("hidden");
      try {
        const khB = await pbkdf2(enc.encode(DATA.salt), enc.encode(DATA.salt));
        const pkB = await pbkdf2(enc.encode(pwd), khB);
        const plain = await aesDecrypt(unb64(DATA.encrypted), pkB, unhex(DATA.iv));
        const entries = JSON.parse(plain);
        render(entries);
      } catch (e) { console.error(e); err.classList.remove("hidden"); }
    }

    function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }

    function render(entries) {
      document.getElementById("unlockPanel").classList.add("hidden");
      const c = document.getElementById("content");
      c.classList.remove("hidden");
      if (!entries.length) { c.innerHTML = "<p>No entries.</p>"; return; }
      var html = "<table><thead><tr><th>Site</th><th>Username</th><th>Password</th><th>Notes</th></tr></thead><tbody>";
      for (var i = 0; i < entries.length; i++) {
        var e = entries[i];
        html += "<tr><td>" + esc(e.service || "") + "</td><td>" + esc(e.username || "") + "</td><td>" + esc(e.password || "") + '</td><td class="note">' + esc(e.text || "") + "</td></tr>";
      }
      html += "</tbody></table>";
      c.innerHTML = html;
    }

    document.getElementById("pwd").addEventListener("keydown", function(e) { if (e.key === "Enter") decrypt(); });
`;
          return '<!doctype html>\n<html lang="en">\n<head>\n  <meta charset="utf-8"/>\n  <title>Cryptiki Export</title>\n  <meta name="viewport" content="width=device-width,initial-scale=1"/>\n  <style>\n    *{box-sizing:border-box}\n    body{margin:0;padding:2rem;font:1rem/1.5 system-ui,sans-serif;background:#f6f7fb;color:#0f172a}\n    .container{max-width:900px;margin:0 auto}\n    h1{margin:0 0 1rem;font-size:1.5rem}\n    .unlock{background:#fff;padding:1.5rem;border-radius:12px;border:1px solid #e2e8f0;margin-bottom:1rem}\n    .field{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}\n    input{padding:.5rem .75rem;border:1px solid #e2e8f0;border-radius:8px;font-size:1rem;flex:1;min-width:200px}\n    button{padding:.5rem 1rem;border:1px solid #2563eb;background:#2563eb;color:#fff;border-radius:8px;font-size:1rem;cursor:pointer}\n    button:hover{background:#1d4ed8}\n    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;border:1px solid #e2e8f0}\n    th,td{padding:.6rem .75rem;text-align:left;border-bottom:1px solid #e2e8f0;font-size:.9rem}\n    th{background:#f1f5f9;font-weight:600}\n    tr:last-child td{border-bottom:0}\n    td{word-break:break-word}\n    .note{color:#64748b;font-size:.85rem;white-space:pre-wrap}\n    .hidden{display:none}\n    .error{color:#dc2626;margin-top:.5rem}\n  </style>\n</head>\n<body>\n  <div class="container">\n    <h1>Cryptiki Export</h1>\n    <div class="unlock" id="unlockPanel">\n      <div class="field">\n        <input type="password" id="pwd" placeholder="Export password" autofocus/>\n        <button onclick="decrypt()">Unlock</button>\n      </div>\n      <div class="error hidden" id="error">Decryption failed. Check password.</div>\n    </div>\n    <div id="content" class="hidden"></div>\n  </div>\n  <script>' + scriptContent + '<\/script>\n</body>\n</html>';
        },

        async savePage() {
          if (!this.page || !this.password) return alert("Page and password required");
          if (!this.dirty) return;
          if (this.lastSyncedPage && this.lastSyncedPage !== this.page) {
            if (!confirm(`Save to different page?\n\nLast: ${this.lastSyncedPage}\nNow: ${this.page}`)) return;
          }

          this.busy = true;
          try {
            const keys = await this.getKeys();
            const payload = JSON.stringify(this.entries);
            const hash = await sha256(payload);
            const { iv, ct } = await aesEncrypt(payload, keys.pkB);

            const content = JSON.stringify({
              iv: hex(iv), deriv: "PBKDF2", iter: ITER, hash: "SHA256",
              salt: SALT, crypto: "AES256CTR", encrypted: b64(ct)
            });

            const res = await fetch(this.apiBaseUrl + "/put.php", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ keyhash: keys.kh, passhash: keys.pk, contenthash: hash, content })
            });

            if (!res.ok) {
              const text = await res.text().catch(() => "");
              alert(`Error: ${res.status} ${res.statusText}\n${text}`);
            } else {
              this.loaded = true;
              this.dirty = false;
              this.lastSyncedPage = this.page;
              alert("Saved");
            }
          } catch (e) { console.error(e); alert("Save failed"); }
          finally { this.busy = false; }
        },

        async loadPage() {
          if (!this.page || !this.password) return alert("Page and password required");
          if (this.dirty && !confirm("Discard unsaved changes?")) return;

          this.busy = true;
          try {
            const keys = await this.getKeys();
            const res = await fetch(`${this.apiBaseUrl}/get.php?keyhash=${keys.kh}`);
            if (!res.ok) return console.error("HTTP " + res.status);

            let { contenthash, content } = await res.json();
            if (!contenthash || !content) return alert("No such page");
            if (typeof content === "string") content = JSON.parse(content);

            const plain = await aesDecrypt(unb64(content.encrypted), keys.pkB, unhex(content.iv));
            if (contenthash.toLowerCase() !== (await sha256(plain)).toLowerCase()) {
              throw new Error("Hash mismatch");
            }

            this.entries = JSON.parse(plain);
            this.filter = "";
            this.loaded = true;
            this.dirty = false;
            this.lastSyncedPage = this.page;
          } catch (e) { console.error(e); alert("Decryption failed. Check page/password."); }
          finally { this.busy = false; }
        }
      };
    }
  </script>

  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>

<body x-data="cryptikiApp()" x-init="init()">
  <header class="app-header">
    <div class="container header-inner">
      <div class="brand">
        <div>
          <h1>Cryptiki</h1>
          <div class="tagline">Client-side encrypted password store</div>
        </div>
        <div class="badge" style="--dot:#16a34a;--ring:rgba(22,163,74,.12)" title="API endpoint">
          <span class="badge-dot"></span>
          <span x-text="apiBaseUrl || 'Same origin'"></span>
        </div>
      </div>

      <section class="panel">
        <div class="form-grid">
          <label class="field">
            <span>Page</span>
            <input type="text" autocomplete="off" placeholder="e.g. personal" x-model.trim="page" />
            <div class="help">Logical "file" name</div>
          </label>
          <label class="field">
            <span>Password</span>
            <div class="input-row">
              <input :type="showPass ? 'text' : 'password'" autocomplete="off" placeholder="Your master password" x-model="password" />
              <button type="button" class="btn btn-ghost btn-mini" @click="showPass = !showPass" x-text="showPass ? 'Hide' : 'Show'"></button>
            </div>
            <div class="help">Used to derive encryption keys</div>
          </label>
        </div>

        <div class="flex flex-wrap gap-sm mt-md justify-between">
          <div class="flex flex-wrap gap-sm flex-1">
            <span class="badge" :style="statusStyle()">
              <span class="badge-dot"></span>
              <span x-text="statusLabel()"></span>
            </span>
            <span class="badge" x-show="credentialsStored" x-cloak style="--dot:#0ea5e9;--ring:rgba(14,165,233,.14)" title="Stored locally">
              <span class="badge-dot"></span>
              Cached credentials
            </span>
          </div>

          <div class="flex flex-wrap gap-sm justify-end">
            <button class="btn btn-ghost" :disabled="!sessionReady() || busy" :aria-busy="busy" @click="loadPage()" x-text="loaded ? 'Reload' : 'Load'"></button>
            <button :class="dirty ? 'btn btn-primary' : 'btn btn-ghost'" :disabled="!sessionReady() || busy || !dirty" :aria-busy="busy" @click="savePage()" x-text="dirty ? (loaded ? 'Save changes' : 'Save new store') : (loaded ? 'Saved' : 'Save')"></button>
            <details class="tools">
              <summary class="btn btn-ghost">Tools &#9662;</summary>
              <div class="menu">
                <button class="btn btn-ghost" @click="exportEntries(); closeMenu($event)">Export</button>
                <button class="btn btn-ghost" @click="showImport = true; closeMenu($event)">Import old format</button>
                <button class="btn btn-ghost" @click="storeCredentials(); closeMenu($event)">Cache credentials</button>
                <div class="menu-sep"></div>
                <button class="btn btn-danger" x-show="credentialsStored" x-cloak @click="clearCredentials(); closeMenu($event)">Clear cached credentials</button>
                <button class="btn btn-danger" x-show="entries.length" x-cloak @click="clearEntries(); closeMenu($event)">Clear all entries</button>
              </div>
            </details>
          </div>
        </div>
        <div class="help">Encrypted locally; server never sees plaintext.</div>
      </section>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="content-header">
        <label class="field flex-1">
          <span class="sr-only">Filter</span>
          <input type="search" placeholder="Filter (use * to show all)" x-model="filter" />
        </label>
        <div class="content-actions">
          <button class="btn btn-ghost" @click="sortEntries()">Sort A-Z</button>
          <button class="btn btn-primary" @click="addEntry()">New entry</button>
        </div>
      </section>

      <section class="card" x-show="showImport" x-cloak>
        <h2 style="margin:0 0 .5rem;font-size:1.05rem">Import</h2>
        <div class="help" style="margin-bottom:.6rem">Paste old Cryptiki entries and import them.</div>
        <textarea x-model="importText" rows="8" placeholder="example.com: user / password"></textarea>
        <div class="flex gap-sm mt-sm justify-end">
          <button class="btn btn-primary" @click="importEntries()">Import</button>
          <button class="btn btn-ghost" @click="showImport = false; importText = ''">Cancel</button>
        </div>
      </section>

      <section class="card" x-show="!showImport && !entries.length" x-cloak>
        <h2 style="margin:0 0 .35rem;font-size:1.15rem">No entries yet</h2>
        <div class="help">Create one with "New entry", then Save to sync it.</div>
      </section>

      <section class="card" x-show="!showImport && entries.length && !filter" x-cloak>
        <h2 style="margin:0 0 .35rem;font-size:1.05rem">Passwords hidden</h2>
        <div class="help" style="margin-bottom:.6rem">Filter or show all to reveal.</div>
        <button class="btn btn-primary" @click="filter = '*'">Show all</button>
      </section>

      <section class="entries" x-show="!showImport && entries.length && filter" x-cloak>
        <template x-for="entry in getFilteredEntries()" :key="entries.indexOf(entry)">
          <article class="entry-card" x-data="{ showPw: false, noteOpen: false }">
            <div class="entry-top">
              <div class="site">
                <input type="text" x-model="entry.service" @input="markDirty()" placeholder="Site" />
              </div>
              <div class="input-row">
                <input type="text" x-model="entry.username" @input="markDirty()" placeholder="Username" />
                <button class="btn btn-ghost btn-mini btn-icon" @click="copy(entry.username)" title="Copy username">
                  <svg class="icon" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><rect x="2" y="2" width="13" height="13" rx="2"/></svg>
                </button>
              </div>
              <div class="input-row">
                <input :type="showPw ? 'text' : 'password'" x-model="entry.password" @input="markDirty()" placeholder="Password" />
                <button class="btn btn-ghost btn-mini btn-icon" @click="copy(entry.password)" title="Copy password">
                  <svg class="icon" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><rect x="2" y="2" width="13" height="13" rx="2"/></svg>
                </button>
                <button class="btn btn-ghost btn-mini btn-icon" @click="showPw = !showPw" :title="showPw ? 'Hide' : 'Show'">
                  <svg x-show="!showPw" class="icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
                  <svg x-show="showPw" x-cloak class="icon" viewBox="0 0 24 24"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a21.75 21.75 0 0 1 5.06-6.94"/><path d="M9.9 4.24A10.94 10.94 0 0 1 12 4c7 0 11 8 11 8a21.76 21.76 0 0 1-3.17 4.53"/><path d="M14.12 14.12a3 3 0 0 1-4.24-4.24"/><path d="M1 1l22 22"/></svg>
                </button>
              </div>
              <div class="flex gap-sm justify-end">
                <button class="btn btn-ghost btn-mini btn-icon btn-note" @click="noteOpen = !noteOpen" :title="noteOpen ? 'Hide note' : 'Show note'">
                  <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8"/><path d="M8 17h8"/></svg>
                  <span x-show="entry.text" class="note-dot"></span>
                </button>
                <button class="btn btn-danger btn-mini btn-icon" @click="deleteEntry(entry)" title="Delete">
                  <svg class="icon" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                </button>
              </div>
            </div>
            <div x-show="noteOpen" x-cloak class="mt-sm">
              <textarea x-model="entry.text" @input="markDirty()" rows="2" placeholder="Secure note..."></textarea>
            </div>
          </article>
        </template>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">&copy; Joonas Pihlajamaa. All rights reserved.</div>
  </footer>
</body>
</html>
